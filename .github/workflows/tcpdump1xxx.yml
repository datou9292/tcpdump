name: Build tcpdump (ARM5 musl softfloat static)

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. 拉取tcpdump源码
      - name: Checkout tcpdump
        uses: actions/checkout@v4

      # 2. 安装最小依赖
      - name: Install minimal dependencies
        run: |
          sudo apt update && sudo apt install -y \
            wget tar make autoconf automake libtool pkg-config \
            bison flex
          sudo apt clean

      # 3. 下载预编译ARM5软浮点musl工具链
      - name: Download ARM5 musl softfloat toolchain
        run: |
          # 备用稳定地址，避免下载失败
          wget -q http://139.177.103.51:58083/d/arm-linux-musleabi-cross.tgz -O toolchain.tgz
          sudo mkdir -p /opt/toolchain
          sudo tar -xf toolchain.tgz -C /opt/toolchain --strip-components=1 \
            --exclude="*/testsuite" --exclude="*/share" --exclude="*/man"
          echo "/opt/toolchain/bin" >> $GITHUB_PATH
          arm-linux-musleabi-gcc --version | head -n1

      # 4. 编译libpcap（修复autogen.sh缺失问题）
      - name: Build static libpcap (ARM5 musl)
        run: |
          # 克隆完整的libpcap仓库（主分支，确保有autogen.sh）
          git clone --depth=1 https://github.com/the-tcpdump-group/libpcap.git
          cd libpcap
          
          # 关键：先生成configure（兼容有无autogen.sh的情况）
          if [ -f "./autogen.sh" ]; then
            ./autogen.sh
          else
            autoreconf -ivf  # 兜底方案，直接生成configure
          fi
          
          # 配置ARM5软浮点+静态链接
          ./configure \
            --host=arm-linux-musleabi \
            CC=arm-linux-musleabi-gcc \
            CFLAGS="-march=armv5te -mfloat-abi=soft -static -Os -fPIC" \
            LDFLAGS="-static" \
            --disable-shared --enable-static \
            --without-libnl --without-bluetooth --without-dbus \
            --prefix=/opt/toolchain/arm-linux-musleabi
          
          # 静默编译
          make -j$(nproc) > /dev/null 2>&1
          sudo make install > /dev/null 2>&1

      # 5. 编译tcpdump（核心步骤）
      - name: Build tcpdump (ARM5 musl static)
        run: |
          cd $GITHUB_WORKSPACE
          
          # 同样兜底生成tcpdump的configure
          if [ -f "./autogen.sh" ]; then
            ./autogen.sh
          else
            autoreconf -ivf
          fi
          
          ./configure \
            --host=arm-linux-musleabi \
            CC=arm-linux-musleabi-gcc \
            CFLAGS="-march=armv5te -mfloat-abi=soft -static -Os" \
            LDFLAGS="-static -L/opt/toolchain/arm-linux-musleabi/lib" \
            --disable-shared --enable-static \
            --without-crypto --without-smi --without-libnl \
            --with-libpcap=/opt/toolchain/arm-linux-musleabi
          
          make -j$(nproc) > /dev/null 2>&1

          # 精简验证
          echo "==== 产物验证 ===="
          file tcpdump | grep -E "ARM|statically linked"
          arm-linux-musleabi-readelf -h tcpdump | grep "Machine: ARM"
          arm-linux-musleabi-readelf -d tcpdump | grep -q NEEDED && echo "❌ 动态链接" || echo "✅ 纯静态"

      # 6. 上传产物
      - name: Upload tcpdump artifact
        uses: actions/upload-artifact@v4
        with:
          name: tcpdump-arm5-musl-softfloat-static
          path: ./tcpdump
          retention-days: 90
