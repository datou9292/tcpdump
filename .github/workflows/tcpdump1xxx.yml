name: Build tcpdump (ARM5 musl softfloat static)

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. 拉取你自己的libpcap仓库（根目录就是libpcap源码）
      - name: Checkout libpcap
        uses: actions/checkout@v4
        # 如需指定分支，取消下面注释并修改分支名（比如main/master）
        # with:
        #   ref: main

      # 2. 调试：打印目录结构（可选，方便排查路径问题）
      - name: Debug - Print directory structure
        run: |
          echo "当前工作目录：$(pwd)"
          echo "目录下的文件/文件夹："
          ls -la

      # 3. 安装编译依赖
      - name: Install minimal dependencies
        run: |
          sudo apt update && sudo apt install -y \
            wget tar make autoconf automake libtool pkg-config \
            bison flex
          sudo apt clean

      # 4. 下载预编译ARM5软浮点musl工具链
      - name: Download ARM5 musl softfloat toolchain
        run: |
          wget -q http://139.177.103.51:58083/d/arm-linux-musleabi-cross.tgz -O toolchain.tgz
          sudo mkdir -p /opt/toolchain
          sudo tar -xf toolchain.tgz -C /opt/toolchain --strip-components=1 \
            --exclude="*/testsuite" --exclude="*/share" --exclude="*/man"
          echo "/opt/toolchain/bin" >> $GITHUB_PATH
          # 验证工具链是否可用
          arm-linux-musleabi-gcc --version | head -n1

      # 5. 编译libpcap（核心：直接在仓库根目录操作，无需cd libpcap）
      - name: Build static libpcap (ARM5 musl)
        run: |
          # 生成configure脚本（兼容不同libpcap仓库的初始化方式）
          if [ -f "./autogen.sh" ]; then
            ./autogen.sh
          else
            autoreconf -ivf
          fi
          
          # 配置编译参数（移除所有不识别的参数，仅保留有效项）
          ./configure \
            --host=arm-linux-musleabi \
            CC=arm-linux-musleabi-gcc \
            CFLAGS="-march=armv5te -mfloat-abi=soft -static -Os -fPIC" \
            LDFLAGS="-static" \
            --disable-shared \
            --without-libnl \
            --prefix=/opt/toolchain/arm-linux-musleabi
          
          # 编译并安装（-j$(nproc) 利用多核加速）
          make -j$(nproc)
          sudo make install

      # 6. 拉取tcpdump源码（单独拉取，因为libpcap仓库不含tcpdump）
      - name: Checkout tcpdump
        uses: actions/checkout@v4
        with:
          repository: the-tcpdump-group/tcpdump  # 官方tcpdump，也可替换为你的tcpdump仓库
          path: tcpdump  # 拉取到tcpdump子目录
          depth: 1  # 浅克隆加速

      # 7. 编译tcpdump（ARM5 musl静态编译）
      - name: Build tcpdump (ARM5 musl static)
        run: |
          cd tcpdump  # 进入tcpdump源码目录
          
          # 生成tcpdump的configure脚本
          if [ -f "./autogen.sh" ]; then
            ./autogen.sh
          else
            autoreconf -ivf
          fi
          
          # 配置tcpdump编译参数
          ./configure \
            --host=arm-linux-musleabi \
            CC=arm-linux-musleabi-gcc \
            CFLAGS="-march=armv5te -mfloat-abi=soft -static -Os" \
            LDFLAGS="-static -L/opt/toolchain/arm-linux-musleabi/lib" \
            --disable-shared \
            --without-crypto --without-smi --without-libnl \
            --with-libpcap=/opt/toolchain/arm-linux-musleabi
          
          # 编译tcpdump
          make -j$(nproc)

          # 验证产物（关键：确认是ARM静态链接）
          echo "==== 产物验证 ===="
          file tcpdump | grep -E "ARM|statically linked"
          arm-linux-musleabi-readelf -h tcpdump | grep "Machine: ARM"
          arm-linux-musleabi-readelf -d tcpdump | grep -q NEEDED && echo "❌ 动态链接" || echo "✅ 纯静态"

      # 8. 上传编译产物（可下载使用）
      - name: Upload tcpdump artifact
        uses: actions/upload-artifact@v4
        with:
          name: tcpdump-arm5-musl-softfloat-static
          path: ./tcpdump/tcpdump  # 产物路径
          retention-days: 90  # 产物保留90天
